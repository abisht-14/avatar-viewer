<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roblox Avatar 3D Viewer</title>
<link rel="stylesheet" href="styles/app.css">
</head>
<body>

<!-- Left Sidebar -->
<div id="sidebar">
  <h1>Avatar Viewer</h1>
  <div class="mode-tabs">
    <button class="mode-tab active" data-mode="inspector">Inspector</button>
    <button class="mode-tab" data-mode="stress">Stress Test</button>
    <button class="mode-tab" data-mode="budget">Budget</button>
    <button class="mode-tab" data-mode="report">Report</button>
  </div>
  <div id="model-list"></div>
</div>

<!-- Center Viewport -->
<div id="viewport">
  <div id="loading"><div class="spinner"></div>Loading model...</div>
  <div id="anim-toolbar">
    <button class="anim-btn active" data-anim="none">None</button>
    <button class="anim-btn" data-anim="idle">Idle</button>
    <button class="anim-btn" data-anim="run">Run</button>
    <button class="anim-btn" data-anim="jump">Jump</button>
    <button class="anim-btn" data-anim="lod" id="lod-toggle">LOD</button>
  </div>
  <button id="visibility-toggle" class="viewport-float-btn" title="Highlight front-facing visible triangles in orange">Visibility</button>
  <div id="budget-container" style="display:none"></div>
  <div id="report-container" style="display:none"></div>
</div>

<!-- Right Panel -->
<div id="panel">
  <section id="ops-panel" class="ops-panel">
    <div class="ops-header">
      <h2>Operations</h2>
      <span id="ops-slo-pill" class="ops-pill">SLO: --</span>
    </div>
    <div class="ops-badges">
      <span id="ops-api-badge" class="ops-badge">API --</span>
      <span id="ops-job-badge" class="ops-badge">Jobs --</span>
    </div>
    <div class="ops-grid">
      <div class="ops-kv"><span>Queue Depth</span><strong id="ops-queue-depth">--</strong></div>
      <div class="ops-kv"><span>Workers</span><strong id="ops-workers">--</strong></div>
      <div class="ops-kv"><span>API p95</span><strong id="ops-api-p95">--</strong></div>
      <div class="ops-kv"><span>Job Success</span><strong id="ops-job-success">--</strong></div>
      <div class="ops-kv"><span>Retries</span><strong id="ops-job-retries">--</strong></div>
    </div>
    <div class="ops-form">
      <label>Category
        <select id="ops-category">
          <option value="all">All</option>
          <option value="rigs">Rigs</option>
          <option value="clothing">Clothing</option>
          <option value="cage_deformers">Cage Deformers</option>
        </select>
      </label>
      <label>Max Models
        <input id="ops-max-models" type="number" min="1" max="200" value="50">
      </label>
      <label>Shards
        <input id="ops-shards" type="number" min="1" max="16" value="4">
      </label>
      <label class="ops-check">
        <input id="ops-inject-failure" type="checkbox">
        Inject transient failure once
      </label>
      <button id="ops-run-benchmark" type="button">Queue Backend Benchmark</button>
    </div>
    <div id="ops-active-job" class="ops-active-job">No active backend job</div>
    <div id="ops-alert-list" class="ops-alert-list"></div>
    <div id="ops-recent-jobs" class="ops-recent-jobs"></div>
  </section>
  <div id="empty-state">Select a model to view performance metrics</div>
  <div id="panel-content" style="display:none">
    <div id="model-title"></div>
    <div id="model-category"></div>

    <div class="render-stats-section">
      <h2>Render Stats <span class="live-badge"></span></h2>
      <div class="render-stats-grid">
        <div class="render-stat" id="rs-front-tris">
          <div class="label">Visible Triangles</div>
          <div class="value">-</div>
          <div class="sub-value" id="rs-front-sub"></div>
        </div>
        <div class="render-stat" id="rs-submitted-tris">
          <div class="label">Submitted to GPU</div>
          <div class="value">-</div>
          <div class="sub-value" id="rs-submitted-sub"></div>
        </div>
        <div class="render-stat" id="rs-visible-meshes">
          <div class="label">Visible Meshes</div>
          <div class="value">-</div>
        </div>
        <div class="render-stat" id="rs-drawcalls">
          <div class="label">Draw Calls</div>
          <div class="value">-</div>
        </div>
        <div class="render-stat" id="rs-cpu-time">
          <div class="label">CPU Render</div>
          <div class="value">-</div>
        </div>
        <div class="render-stat" id="rs-gpu-time">
          <div class="label">GPU Render</div>
          <div class="value">-</div>
        </div>
        <div class="render-stat" id="rs-fps">
          <div class="label">FPS</div>
          <div class="value">-</div>
          <div class="fps-bar-track"><div class="fps-bar-fill" id="fps-fill"></div></div>
        </div>
        <div class="render-stat" id="rs-frametime">
          <div class="label">Frame Time</div>
          <div class="value">-</div>
        </div>
      </div>

      <div class="pipeline-section">
        <h3>Frame Budget (16.7ms target)</h3>
        <div class="pipeline-bar" id="pipeline-bar">
          <div class="seg seg-cpu" id="seg-cpu"></div>
          <div class="seg seg-gpu" id="seg-gpu"></div>
          <div class="seg seg-idle" id="seg-idle"></div>
        </div>
        <div class="pipeline-legend">
          <span><span class="dot" style="background:#4488cc"></span>CPU</span>
          <span><span class="dot" style="background:#cc6644"></span>GPU</span>
          <span><span class="dot" style="background:#2a2a4a"></span>Idle</span>
          <span id="budget-pct"></span>
        </div>
      </div>

      <div class="pipeline-section">
        <h3>Shader &amp; Lighting Cost</h3>
        <div class="shader-grid">
          <div class="shader-item" id="si-lights">
            <div class="label">Lights</div>
            <div class="value">-</div>
          </div>
          <div class="shader-item" id="si-programs">
            <div class="label">Shader Programs</div>
            <div class="value">-</div>
          </div>
          <div class="shader-item" id="si-materials">
            <div class="label">Material Types</div>
            <div class="value">-</div>
          </div>
          <div class="shader-item" id="si-textures-gpu">
            <div class="label">GPU Textures</div>
            <div class="value">-</div>
          </div>
        </div>
      </div>

      <div class="render-stats-note" id="rs-note"></div>
      <div class="render-stats-note" id="platform-note"></div>
    </div>

    <hr class="section-divider">

    <div class="gpu-info-section">
      <h2>GPU Hardware</h2>
      <div class="gpu-hw-card">
        <div class="gpu-name" id="gpu-renderer-name">Detecting...</div>
        <div class="gpu-vendor" id="gpu-vendor-name"></div>
      </div>
      <div class="gpu-caps-grid">
        <div class="gpu-cap">
          <div class="label">WebGL</div>
          <div class="value" id="gc-webgl">-</div>
        </div>
        <div class="gpu-cap">
          <div class="label">Max Texture</div>
          <div class="value" id="gc-maxtex">-</div>
        </div>
        <div class="gpu-cap">
          <div class="label">Max Vert Uniforms</div>
          <div class="value" id="gc-vertunif">-</div>
        </div>
        <div class="gpu-cap">
          <div class="label">Max Frag Uniforms</div>
          <div class="value" id="gc-fragunif">-</div>
        </div>
        <div class="gpu-cap">
          <div class="label">Max Vert Attribs</div>
          <div class="value" id="gc-attribs">-</div>
        </div>
        <div class="gpu-cap">
          <div class="label">Max Varyings</div>
          <div class="value" id="gc-varyings">-</div>
        </div>
        <div class="gpu-cap">
          <div class="label">Max Viewport</div>
          <div class="value" id="gc-viewport">-</div>
        </div>
        <div class="gpu-cap">
          <div class="label">Precision</div>
          <div class="value" id="gc-precision">-</div>
        </div>
      </div>
      <div class="gpu-ext-list" id="gpu-ext-list"></div>
    </div>

    <hr class="section-divider">
    <h2>Asset Metrics</h2>
    <div class="metrics-grid">
      <div class="metric-card" id="mc-vertices">
        <div class="label">Vertices</div>
        <div class="value">-</div>
      </div>
      <div class="metric-card" id="mc-faces">
        <div class="label">Faces</div>
        <div class="value">-</div>
      </div>
      <div class="metric-card" id="mc-meshes">
        <div class="label">Meshes</div>
        <div class="value">-</div>
      </div>
      <div class="metric-card" id="mc-joints">
        <div class="label">Skeleton Joints</div>
        <div class="value">-</div>
      </div>
      <div class="metric-card" id="mc-materials">
        <div class="label">Materials</div>
        <div class="value">-</div>
      </div>
      <div class="metric-card" id="mc-textures">
        <div class="label">Textures</div>
        <div class="value">-</div>
      </div>
    </div>

    <div class="gpu-bar-container">
      <div class="gpu-bar-label">GPU Memory Estimate</div>
      <div class="gpu-bar-value" id="gpu-total">-</div>
      <div class="gpu-bar-track"><div class="gpu-bar-fill" id="gpu-fill"></div></div>
      <div class="gpu-breakdown">
        <span>VB: <span id="gpu-vb">-</span></span>
        <span>IB: <span id="gpu-ib">-</span></span>
        <span>Bones: <span id="gpu-bm">-</span></span>
      </div>
    </div>

    <div id="warnings-box">
      <div class="warn-header">Warnings</div>
      <div id="warnings-list"></div>
    </div>

    <div id="mesh-table-container">
      <h3>Mesh Breakdown (by face count)</h3>
      <table id="mesh-table">
        <thead><tr>
          <th data-key="name" data-type="string">Mesh <span class="sort-arrow"></span></th>
          <th data-key="vertices" data-type="num">Verts <span class="sort-arrow"></span></th>
          <th data-key="faces" data-type="num" class="sorted">Faces <span class="sort-arrow"></span></th>
          <th data-key="bones" data-type="num">Skin Bones <span class="sort-arrow"></span></th>
        </tr></thead>
        <tbody id="mesh-tbody"></tbody>
      </table>
    </div>
  </div>
  <div id="stress-controls" class="stress-controls" style="display:none">
    <h2>Stress Test Controls</h2>
    <div class="stress-slider-row">
      <input type="range" id="stress-slider" min="1" max="50" value="1">
      <span class="count-label" id="stress-count-label">1</span>
    </div>
    <div class="quick-btns">
      <button class="quick-btn active" data-count="1">1</button>
      <button class="quick-btn" data-count="4">4</button>
      <button class="quick-btn" data-count="9">9</button>
      <button class="quick-btn" data-count="16">16</button>
      <button class="quick-btn" data-count="25">25</button>
      <button class="quick-btn" data-count="49">49</button>
    </div>
    <div class="stress-toggle">
      <label><input type="checkbox" id="stress-anim-toggle" checked> Animate All Clones</label>
    </div>
    <div class="stress-anim-bar">
      <button class="stress-anim-btn active" data-anim="none">None</button>
      <button class="stress-anim-btn" data-anim="idle">Idle</button>
      <button class="stress-anim-btn" data-anim="run">Run</button>
      <button class="stress-anim-btn" data-anim="jump">Jump</button>
    </div>
    <div class="stress-live-metrics">
      <div class="stress-metric large">
        <div class="label">Current FPS</div>
        <div class="value" id="stress-fps">--</div>
      </div>
      <div class="stress-metric">
        <div class="label">Total Triangles</div>
        <div class="value" id="stress-tris">--</div>
      </div>
      <div class="stress-metric">
        <div class="label">Draw Calls</div>
        <div class="value" id="stress-dc">--</div>
      </div>
      <div class="stress-metric">
        <div class="label">Est. GPU Memory</div>
        <div class="value" id="stress-gpu">--</div>
      </div>
      <div class="stress-metric">
        <div class="label">Clone Count</div>
        <div class="value" id="stress-clones">0</div>
      </div>
      <div class="stress-metric">
        <div class="label">CPU Render</div>
        <div class="value" id="stress-cpu">--</div>
      </div>
      <div class="stress-metric">
        <div class="label">GPU Render</div>
        <div class="value" id="stress-gpu-time">--</div>
      </div>
      <div class="stress-metric">
        <div class="label">CPU Total/Frame</div>
        <div class="value" id="stress-cpu-total">--</div>
      </div>
      <div class="stress-metric">
        <div class="label">CPU Utilization</div>
        <div class="value" id="stress-cpu-util">--</div>
      </div>
      <div class="stress-metric large">
        <div class="label">JS Heap</div>
        <div class="value" id="stress-js-heap">--</div>
      </div>
    </div>
    <div class="pipeline-section">
      <h3>Frame Budget (16.7ms target)</h3>
      <div class="pipeline-bar" id="stress-pipeline-bar">
        <div class="seg seg-cpu" id="stress-seg-cpu"></div>
        <div class="seg seg-gpu" id="stress-seg-gpu"></div>
        <div class="seg seg-idle" id="stress-seg-idle"></div>
      </div>
      <div class="pipeline-legend">
        <span><span class="dot" style="background:#4488cc"></span>CPU</span>
        <span><span class="dot" style="background:#cc6644"></span>GPU</span>
        <span><span class="dot" style="background:#2a2a4a"></span>Idle</span>
        <span id="stress-budget-pct"></span>
      </div>
    </div>
    <div class="fps-chart-container">
      <h3>FPS History</h3>
      <canvas id="fps-sparkline"></canvas>
    </div>
    <div class="scaling-table-container">
      <h3>Scaling Snapshots</h3>
      <table class="scaling-table">
        <thead><tr><th>Count</th><th>FPS</th><th>Draw Calls</th><th>Triangles</th></tr></thead>
        <tbody id="scaling-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.167.0/examples/jsm/"
  }
}
</script>
<script type="module" src="js/main.js"></script>
</body>
</html>
